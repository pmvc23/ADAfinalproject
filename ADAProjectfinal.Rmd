---
title: "Evaluating labor induction and cesarean delivery in rural Ghana"
author: "Peter McCarthy"
date: "`r Sys.Date()`"
output: html_document
---
```{r}
library(tidyverse)
library(gtsummary)
library(readxl)
library(broom)
library(car)                 # VIF
library(ResourceSelection)   # Hosmer–Lemeshow
library(DiagrammeR)          # Flow diagram

options(dplyr.summarise.inform = FALSE)

```

```{r}
# Read in the raw dataset 

mat_raw <- read_excel("ADA folder/matdata.xlsx")

# Recode variables and create analysis-ready dataset

mat <- mat_raw %>%
mutate(
# Delivery mode: 1 = Vaginal, 2 = CS
mode = factor(mode,
levels = c(1, 2),
labels = c("Vaginal", "CS")),
mode_bin = ifelse(mode == "CS", 1, 0),

# Induction of labor: 1 = induced, 2 = not induced, 3 = not stated (set to NA)
induction = case_when(
  induction %in% c(1, "1") ~ "Induced",
  induction %in% c(2, "2") ~ "Not induced",
  induction %in% c(3, "3") ~ NA_character_,  # "not stated" treated as missing
  TRUE ~ NA_character_
),
induction = factor(induction, levels = c("Not induced", "Induced")),

# Previous CS: 1 = Yes, 2 = No
previousCS = case_when(
  previousCS %in% c(1, "1") ~ "Yes",
  previousCS %in% c(2, "2") ~ "No",
  TRUE ~ NA_character_
),
previousCS = factor(previousCS, levels = c("No", "Yes")),

# Sex of baby: 1 = Male, 2 = Female
sex = case_when(
  sex %in% c(1, "1") ~ "Male",
  sex %in% c(2, "2") ~ "Female",
  TRUE ~ NA_character_
),
sex = factor(sex, levels = c("Male", "Female")),

# Presentation: 1 = Cephalic, 2 = Breech
presentation = case_when(
  presentation %in% c(1, "1") ~ "Cephalic",
  presentation %in% c(2, "2") ~ "Breech",
  TRUE ~ NA_character_
),
presentation = factor(presentation, levels = c("Cephalic", "Breech")),

# Numeric variables
age       = as.numeric(age),
GA        = as.numeric(GA),
BW        = as.numeric(BW),
hb        = as.numeric(hb),
gravidity = as.numeric(gravidity),

# Reason for CS (categorical)
otherReason4CS = factor(otherReason4CS),

# Occupation & Education as factors
occupation = factor(occupation),
education  = factor(education)

)

glimpse(mat)

```
```{r}
table(mat$mode,         useNA = "ifany")
table(mat$induction,    useNA = "ifany")
table(mat$previousCS,   useNA = "ifany")
table(mat$presentation, useNA = "ifany")
table(mat$sex,          useNA = "ifany")
table(mat$mode_bin,     useNA = "ifany")

```
```{r}
# 0) All records

n_start <- nrow(mat)

# 1) Non-missing mode (vaginal vs CS)

mat_step1 <- mat %>%
filter(!is.na(mode_bin))
n_step1 <- nrow(mat_step1)

# 2) Non-missing induction (excludes "not stated" coded as NA)

mat_step2 <- mat_step1 %>%
filter(!is.na(induction))
n_step2 <- nrow(mat_step2)

# 3) Non-missing previous CS

mat_step3 <- mat_step2 %>%
filter(!is.na(previousCS))
n_step3 <- nrow(mat_step3)

# 4) Non-missing key covariates (age, GA, gravidity)

mat_cc <- mat_step3 %>%
filter(
!is.na(age),
!is.na(GA),
!is.na(gravidity)
)
n_final <- nrow(mat_cc)

# Print sample sizes at each step

n_start; n_step1; n_step2; n_step3; n_final

# Flow table for reporting (final analytic sample = complete cases)

flow_table <- tibble::tibble(
step_order = 1:5,
step_label = c(
"All records in matdata.xlsx",
"Non-missing mode (Vaginal/CS)",
"Non-missing induction (exclude 'not stated')",
"Non-missing previous CS",
"Non-missing age, GA, gravidity (final analytic sample)"
),
n = c(
n_start,
n_step1,
n_step2,
n_step3,
n_final
)
)

flow_table

# Summary of key variables in analytic dataset

summary(mat_cc[, c("mode", "mode_bin", "induction", "age", "GA", "gravidity", "previousCS")])

```
```{r}
# Outcome: mode_bin (1 = CS, 0 = vaginal)

# Exposure: induction

# Covariates: age, GA, gravidity, previousCS

# Interaction: induction * age (secondary objective)

fit_cc <- glm(
mode_bin ~ induction * age + GA + gravidity + previousCS,
data   = mat_cc,
family = binomial
)

summary(fit_cc)

```
```{r}
# ORs and 95% CIs

OR_table <- exp(cbind(
OR   = coef(fit_cc),
confint(fit_cc)
))

OR_table

```
```{r}
# Multicollinearity (VIF)

vif(fit_cc)

# Hosmer–Lemeshow goodness-of-fit test (g = 10 groups)

hoslem.test(mat_cc$mode_bin, fitted(fit_cc), g = 10)

# Prepare data for checking ranges of continuous variables

bt_data <- mat_cc %>%
select(mode_bin, age, GA, gravidity) %>%
na.omit()

summary(bt_data)

# Check for problematic values for potential Box–Tidwell tests

sapply(bt_data[, c("age", "GA", "gravidity")], function(x) {
c(
min      = min(x),
any_leq0 = any(x <= 0),
any_na   = any(is.na(x)),
any_inf  = any(is.infinite(x))
)
})

```
```{r}
# Categorize age, GA, and gravidity for approximate linearity checks

mat_cc_cat <- mat_cc %>%
mutate(
age_cat = cut(
age,
breaks = quantile(age, probs = c(0, .25, .5, .75, 1), na.rm = TRUE),
include.lowest = TRUE
),
GA_cat = cut(
GA,
breaks = quantile(GA, probs = c(0, .25, .5, .75, 1), na.rm = TRUE),
include.lowest = TRUE
),
grav_cat = cut(
gravidity,
breaks = c(1, 2, 3, 4, Inf),
labels = c("1", "2", "3", "4+"),
include.lowest = TRUE
)
)

# Proportion CS within each category

prop.table(table(mat_cc_cat$age_cat,  mat_cc_cat$mode_bin), 1)
prop.table(table(mat_cc_cat$GA_cat,   mat_cc_cat$mode_bin), 1)
prop.table(table(mat_cc_cat$grav_cat, mat_cc_cat$mode_bin), 1)

```
```{r}
DiagrammeR::grViz(sprintf("
digraph flow {
graph [rankdir = TB, fontsize = 14,
label = 'Sample Size Flow Diagram\n\nThis chart shows how the analytic sample was reduced to 254 complete cases.', labelloc = t]

node [shape = rectangle, style = filled,
fillcolor = \"#f5f5f5\", fontname = \"Garamond\"]
edge [fontname = \"Garamond\", fontsize = 10]

# Nodes

n0  [label = 'All records\n(n = %d)']

d1  [label = 'Mode recorded?', shape = rectangle,
fillcolor = \"#e0e0e0\"]
n1  [label = 'Non-missing mode\n(n = %d)']
x1  [label = 'Excluded\n(missing mode)', fillcolor = \"#ffebee\"]

d2  [label = 'Induction recorded?', shape = rectangle,
fillcolor = \"#e0e0e0\"]
n2  [label = 'Non-missing induction\n(n = %d)']
x2  [label = 'Excluded\n(induction not stated/NA)', fillcolor = \"#ffebee\"]

d3  [label = 'Previous CS recorded?', shape = rectangle,
fillcolor = \"#e0e0e0\"]
n3  [label = 'Non-missing previous CS\n(n = %d)']
x3  [label = 'Excluded\n(missing previous CS)', fillcolor = \"#ffebee\"]

d4  [label = 'Age, GA, gravidity complete?', shape = rectangle,
fillcolor = \"#e0e0e0\"]
n4  [label = 'Final analytic sample\nComplete covariates\n(n = %d)']
x4  [label = 'Excluded\n(incomplete covariates)', fillcolor = \"#ffebee\"]

# Edges

n0 -> d1

d1 -> n1 [label = 'Yes']
d1 -> x1 [label = 'No']

n1 -> d2
d2 -> n2 [label = 'Yes']
d2 -> x2 [label = 'No']

n2 -> d3
d3 -> n3 [label = 'Yes']
d3 -> x3 [label = 'No']

n3 -> d4
d4 -> n4 [label = 'Yes']
d4 -> x4 [label = 'No']
}
", n_start, n_step1, n_step2, n_step3, n_final))

```
```{r}
library(gtsummary)

table1_gt <- mat_cc %>%
  select(age, GA, gravidity, induction, previousCS, sex, presentation) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "no"
  ) %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 1. Characteristics of the Study Population (n = 254)**")

table1_gt

```

```{r}
library(knitr)
library(kableExtra)
library(dplyr)

### --- VIF TABLE ---
vif_table <- vif(fit_cc) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Variable") %>%
  rename(VIF = 2)

kable(vif_table, caption = "Variance Inflation Factors (VIF) for Regression Predictors") %>%
  kable_styling(full_width = FALSE)

### --- HOSMER–LEMESHOW TABLE ---
hl <- hoslem.test(mat_cc$mode_bin, fitted(fit_cc), g = 10)

hl_table <- data.frame(
  Statistic = "Hosmer–Lemeshow X²",
  Value = hl$statistic,
  DF = hl$parameter,
  P_value = hl$p.value
)

kable(hl_table, caption = "Hosmer–Lemeshow Goodness-of-Fit Test") %>%
  kable_styling(full_width = FALSE)

### --- SUMMARY TABLE FOR CONTINUOUS VARIABLES ---
summary_table <- mat_cc %>%
  summarise(
    min_age = min(age), q1_age = quantile(age, .25), median_age = median(age),
    mean_age = mean(age), q3_age = quantile(age, .75), max_age = max(age),

    min_GA = min(GA), q1_GA = quantile(GA, .25), median_GA = median(GA),
    mean_GA = mean(GA), q3_GA = quantile(GA, .75), max_GA = max(GA),

    min_grav = min(gravidity), q1_grav = quantile(gravidity, .25),
    median_grav = median(gravidity), mean_grav = mean(gravidity),
    q3_grav = quantile(gravidity, .75), max_grav = max(gravidity)
  ) %>%
  pivot_longer(everything(),
               names_to = "Metric",
               values_to = "Value")

kable(summary_table, caption = "Summary Statistics for Continuous Covariates") %>%
  kable_styling(full_width = FALSE)

### --- LINEARITY (BOX–TIDWELL-LIKE) TABLE ---
bt_data <- mat_cc %>%
  select(age, GA, gravidity)

linearity_table <- data.frame(
  Variable = c("age", "GA", "gravidity"),
  Min = c(min(bt_data$age), min(bt_data$GA), min(bt_data$gravidity)),
  Max = c(max(bt_data$age), max(bt_data$GA), max(bt_data$gravidity)),
  Any_NA = c(any(is.na(bt_data$age)),
             any(is.na(bt_data$GA)),
             any(is.na(bt_data$gravidity))),
  Any_Zero_or_Neg = c(any(bt_data$age <= 0),
                      any(bt_data$GA <= 0),
                      any(bt_data$gravidity <= 0)),
  Any_Inf = c(any(is.infinite(bt_data$age)),
              any(is.infinite(bt_data$GA)),
              any(is.infinite(bt_data$gravidity)))
)

kable(linearity_table, caption = "Linearity Diagnostics for Continuous Predictors") %>%
  kable_styling(full_width = FALSE)

```
```{r}
library(dplyr)
library(knitr)
library(kableExtra)
library(broom)

apa_OR <- exp(cbind(
  OR = coef(fit_cc),
  confint(fit_cc)
)) %>%
  as.data.frame() %>%
  mutate(
    Predictor = c(
      "Intercept",
      "Induction (Induced vs Not induced)",
      "Maternal age (years)",
      "Gestational age (weeks)",
      "Gravidity",
      "Previous cesarean (Yes vs No)",
      "Induction × Maternal age"
    ),
    OR = round(OR, 2),
    CI = paste0(
      round(`2.5 %`, 2), " – ",
      round(`97.5 %`, 2)
    )
  ) %>%
  select(Predictor, OR, CI)

kable(
  apa_OR[-1, ],  # remove intercept row
  align = "lcc",
  caption = "Adjusted Odds Ratios Predicting Cesarean Delivery Among Term Pregnancies (N = 254)"
) %>%
  kable_styling(full_width = FALSE, position = "center")

```



